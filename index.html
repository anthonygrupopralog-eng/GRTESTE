<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist de Frota</title>
<link rel="icon" href="https://www.pralog.com.br/wp-content/uploads/2025/07/cropped-pralogverde-scaled-e1752780666907-32x32.png" sizes="32x32">
<link rel="icon" href="https://www.pralog.com.br/wp-content/uploads/2025/07/cropped-pralogverde-scaled-e1752780666907-192x192.png" sizes="192x192">
<link rel="apple-touch-icon" href="https://www.pralog.com.br/wp-content/uploads/2025/07/cropped-pralogverde-scaled-e1752780666907-180x180.png">
<meta name="msapplication-TileImage" content="https://www.pralog.com.br/wp-content/uploads/2025/07/cropped-pralogverde-scaled-e1752780666907-270x270.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{background:#f4f6f8;color:#333;padding:20px}
.header{background:#1f2937;color:#fff;padding:20px;border-radius:10px;margin-bottom:20px}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
.card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 8px rgba(0,0,0,.08)}
.card span{font-size:26px;font-weight:bold}
.card.total{border-left:6px solid #3b82f6}
.card.ok{border-left:6px solid #22c55e}
.card.warning{border-left:6px solid #facc15}
.card.danger{border-left:6px solid #ef4444}
.filters{background:#fff;padding:15px;border-radius:10px;display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px}
.filters input,.filters select{padding:10px;border-radius:8px;border:1px solid #d1d5db}
button{padding:8px 18px;border:none;border-radius:10px;background:#111827;color:#fff;cursor:pointer}
button:hover{background:#1f2937}
button:disabled{opacity:.9}
.table-container{background:#fff;padding:15px;border-radius:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid #e5e7eb}
thead th{border-bottom:2px solid #e5e7eb}
.center{text-align:center}
.status.ok{color:#16a34a;font-weight:bold}
.status.warning{color:#ca8a04;font-weight:bold}
.status.danger{color:#dc2626;font-weight:bold}
tbody tr:hover{background:#f9fafb}
</style>
</head>

<body>

<div class="header">
  <h2>Checklist Mensal da Frota</h2>
</div>

<div class="dashboard">
  <div class="card total">Total<br><span id="total">0</span></div>
  <div class="card ok">Em dia<br><span id="ok">0</span></div>
  <div class="card warning">Pendentes<br><span id="pendente">0</span></div>
  <div class="card danger">Vencidos<br><span id="vencido">0</span></div>
</div>

<div class="filters">
  <input id="placaInput" placeholder="Placa">
  <select id="tipoInput">
    <option value="">Tipo</option>
    <option>Truck</option>
    <option>Carreta</option>
    <option>VUC</option>
    <option>Cavalo - Prafarma</option>
    <option>Cavalo - Pralog</option>
    <option>Cavalo - Pety</option>
  </select>
  <button id="btnCadastrar">Cadastrar</button>

  <input type="file" id="excelInput">
  <button onclick="exportarExcel()">Exportar Excel</button>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Placa</th>
        <th class="center">Tipo</th>
        <th class="center">√öltimo Checklist</th>
        <th class="center">Status</th>
        <th class="center">A√ß√£o</th>
      </tr>
    </thead>
    <tbody id="tabela"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  query, where, onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* üî• FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyB61mrR6417ECkuUCsbBqLU3KQ_hepXiQs",
  authDomain: "check-list-d32b1.firebaseapp.com",
  projectId: "check-list-d32b1",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* üìå ELEMENTOS */
const placaInput = document.getElementById("placaInput");
const tipoInput = document.getElementById("tipoInput");
const btnCadastrar = document.getElementById("btnCadastrar");
const tabelaBody = document.getElementById("tabela");

const totalEl = document.getElementById("total");
const okEl = document.getElementById("ok");
const pendenteEl = document.getElementById("pendente");
const vencidoEl = document.getElementById("vencido");

/* =========================
   üîÅ RENDER SEM DUPLICAR
   (debounce + evita render concorrente)
========================= */
let renderTimeout;
let isRendering = false;
let rerenderRequested = false;

async function renderizarSeguro() {
  if (isRendering) {
    rerenderRequested = true;
    return;
  }
  isRendering = true;
  try {
    await renderizar();
  } finally {
    isRendering = false;
    if (rerenderRequested) {
      rerenderRequested = false;
      await renderizarSeguro();
    }
  }
}

function agendarRender() {
  clearTimeout(renderTimeout);
  renderTimeout = setTimeout(renderizarSeguro, 120);
}

/* üöó CADASTRAR PLACA */
btnCadastrar.onclick = async (e) => {
  e.preventDefault();
  const placa = placaInput.value.trim().toUpperCase();
  const tipo = tipoInput.value;

  if (!placa || !tipo) {
    alert("Preencha placa e tipo");
    return;
  }

  const q = query(collection(db, "placas"), where("placa", "==", placa));
  if (!(await getDocs(q)).empty) {
    alert("Placa j√° cadastrada");
    return;
  }

  await addDoc(collection(db, "placas"), { placa, tipo });

  placaInput.value = "";
  tipoInput.value = "";

  // Atualiza na hora e mostra o alerta
  await renderizarSeguro();
  alert("‚úÖ Placa cadastrada com sucesso!");
  placaInput.focus();
};

/* üìÜ STATUS */
function calcularStatus(data) {
  if (!data) return { texto: "Pendente", classe: "warning" };

  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);

  const check = new Date(data);
  check.setHours(0, 0, 0, 0);

  const diff = Math.floor((hoje - check) / (1000 * 60 * 60 * 24));

  if (diff < 30) return { texto: "Em dia", classe: "ok" };
  if (diff === 30) return { texto: "Pendente", classe: "warning" };
  return { texto: "Vencido", classe: "danger" };
}

/* üñ•Ô∏è RENDER */
async function renderizar() {
  tabelaBody.innerHTML = "";

  let total = 0, ok = 0, pend = 0, venc = 0;

  const [placasSnap, checksSnap] = await Promise.all([
    getDocs(collection(db, "placas")),
    getDocs(collection(db, "checklists"))
  ]);

  const checks = {};
  checksSnap.forEach((d) => {
    const c = d.data();
    if (!checks[c.placa] || checks[c.placa] < c.dataChecklist) {
      checks[c.placa] = c.dataChecklist;
    }
  });

  const hojeISO = new Date().toISOString().slice(0, 10);

  placasSnap.forEach((doc) => {
    const { placa, tipo } = doc.data();
    total++;

    const data = checks[placa] || null;
    const st = calcularStatus(data);

    if (st.texto === "Em dia") ok++;
    else if (st.texto === "Pendente") pend++;
    else venc++;

    const feitoHoje = data === hojeISO;

    tabelaBody.innerHTML += `
      <tr>
        <td>${placa}</td>
        <td class="center">${tipo}</td>
        <td class="center">${data ? data.split("-").reverse().join("/") : "-"}</td>
        <td class="center status ${st.classe}">${st.texto}</td>
        <td class="center">
          <button
            ${feitoHoje ? 'disabled style="background:#16a34a;cursor:default;"' : ''}
            onclick="salvarChecklist('${placa}', this)">
            ${feitoHoje ? "‚úî Feito" : "Checklist"}
          </button>
        </td>
      </tr>`;
  });

  totalEl.innerText = total;
  okEl.innerText = ok;
  pendenteEl.innerText = pend;
  vencidoEl.innerText = venc;
}

/* ‚úÖ CHECKLIST */
window.salvarChecklist = async (placa, botao) => {
  try {
    botao.disabled = true;
    botao.textContent = "Salvando...";
    botao.style.background = "#f59e0b";
    botao.style.cursor = "default";

    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    const data = hoje.toISOString().slice(0, 10);

    const q = query(
      collection(db, "checklists"),
      where("placa", "==", placa),
      where("dataChecklist", "==", data)
    );

    if (!(await getDocs(q)).empty) {
      alert("Checklist j√° feito hoje");
      await renderizarSeguro();
      return;
    }

    await addDoc(collection(db, "checklists"), {
      placa,
      dataChecklist: data,
    });

    await renderizarSeguro(); // atualiza na hora

    // feedback visual imediato
    botao.textContent = "‚úî Feito";
    botao.style.background = "#16a34a";
    botao.disabled = true;
  } catch (e) {
    console.error("Erro ao salvar checklist:", e);
    alert("Erro ao salvar checklist!");
    if (botao) {
      botao.disabled = false;
      botao.textContent = "Checklist";
      botao.style.background = "#111827";
      botao.style.cursor = "pointer";
    }
  }
};

/* üîÅ ATUALIZA√á√ÉO AUTOM√ÅTICA (placas + checklists) */
onSnapshot(collection(db, "placas"), agendarRender);
onSnapshot(collection(db, "checklists"), agendarRender);

// primeira carga
agendarRender();

/* evita erro se exportarExcel n√£o existir ainda */
window.exportarExcel = window.exportarExcel || function () {
  alert("Fun√ß√£o exportarExcel() ainda n√£o foi implementada.");
};
</script>
</body>
</html>
