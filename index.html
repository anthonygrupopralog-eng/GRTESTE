<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist de Frota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f4f6f8;padding:20px}
.hidden{display:none}
button{padding:8px 16px;border:none;border-radius:8px;background:#111827;color:#fff;cursor:pointer}
button:hover{opacity:.9}
input,select{padding:8px;border-radius:8px;border:1px solid #ccc}
.card{background:#fff;padding:15px;border-radius:12px;margin-bottom:15px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:center}
.badge{padding:4px 10px;border-radius:20px;color:#fff;font-size:12px}
.admin{background:#16a34a}
.user{background:#2563eb}
.off{background:#dc2626}
.status.ok{color:#16a34a;font-weight:bold}
.status.warning{color:#ca8a04;font-weight:bold}
.status.danger{color:#dc2626;font-weight:bold;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
.dark{background:#111827;color:#eee}
.dark .card{background:#1f2937}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="card">
  <h3>Login</h3>
  <input id="email" placeholder="Email"><br><br>
  <input id="senha" type="password" placeholder="Senha"><br><br>
  <button id="btnLogin">Entrar</button>
  <button id="btnRegister">Registrar</button>
  <p id="msg"></p>
</div>

<!-- APP -->
<div id="app" class="hidden">

  <!-- TOPO -->
  <div class="card">
    <b id="userInfo"></b>
    <button id="logout">Sair</button>
    <button id="theme">游깿 Tema</button>
    <button id="btnUsers" class="hidden">游논 Usu치rios</button>
  </div>

  <!-- DASHBOARD -->
  <div class="dashboard">
    <div class="card">Total<br><b id="tTotal">0</b></div>
    <div class="card">Em dia<br><b id="tOk">0</b></div>
    <div class="card">Pendentes<br><b id="tPend">0</b></div>
    <div class="card">Vencidos<br><b id="tVenc">0</b></div>
  </div>

  <!-- FILTROS -->
  <div class="card">
    <input id="search" placeholder="Pesquisar placa">
    <input id="placa" placeholder="Placa">
    <select id="tipo">
      <option value="">Tipo</option>
      <option>Truck</option>
      <option>Carreta</option>
      <option>VUC</option>
    </select>
    <button id="btnCadastrar">Cadastrar Placa</button>
    <button onclick="exportarExcel()">Exportar Excel</button>
  </div>

  <!-- TABELA -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Placa</th>
          <th>Tipo</th>
          <th>칔ltimo</th>
          <th>Status</th>
          <th>A칞칚o</th>
        </tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>
  </div>

  <!-- USU츼RIOS -->
  <div id="usersPanel" class="card hidden">
    <h3>Gerenciar Usu치rios</h3>
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Perfil</th>
          <th>Status</th>
          <th>A칞칫es</th>
        </tr>
      </thead>
      <tbody id="usersTable"></tbody>
    </table>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "check-list-d32b1.firebaseapp.com",
  projectId: "check-list-d32b1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* LOGIN */
btnLogin.onclick = async ()=>{
  try{ await signInWithEmailAndPassword(auth,email.value,senha.value); }
  catch{ msg.innerText="Erro no login"; }
};

btnRegister.onclick = async ()=>{
  const u = await createUserWithEmailAndPassword(auth,email.value,senha.value);
  await setDoc(doc(db,"users",u.user.uid),{
    email:u.user.email, role:"user", active:true
  });
  msg.innerText="Registrado! Fa칞a login.";
};

logout.onclick = ()=>signOut(auth);

/* AUTH */
onAuthStateChanged(auth, async user=>{
  if(!user){ login.classList.remove("hidden"); app.classList.add("hidden"); return; }
  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || !snap.data().active){ alert("Usu치rio bloqueado"); signOut(auth); return; }

  login.classList.add("hidden");
  app.classList.remove("hidden");
  userInfo.innerText = user.email+" ("+snap.data().role+")";

  if(snap.data().role==="admin"){
    btnUsers.classList.remove("hidden");
    carregarUsuarios();
  }

  renderizar();
});

/* CADASTRAR PLACA */
btnCadastrar.onclick = async ()=>{
  if(!placa.value || !tipo.value) return alert("Preencha tudo");
  const q = query(collection(db,"placas"), where("placa","==",placa.value.toUpperCase()));
  if(!(await getDocs(q)).empty) return alert("Placa j치 existe");
  await addDoc(collection(db,"placas"),{ placa:placa.value.toUpperCase(), tipo:tipo.value });
  placa.value=""; tipo.value="";
  renderizar();
};

/* STATUS */
function status(data){
  if(!data) return ["Pendente","warning"];
  const d = (new Date()-new Date(data))/(1000*60*60*24);
  if(d<30) return ["Em dia","ok"];
  if(d===30) return ["Pendente","warning"];
  return ["Vencido","danger"];
}

/* RENDER */
async function renderizar(){
  tabela.innerHTML="";
  let t=0,o=0,p=0,v=0;

  const placas = await getDocs(collection(db,"placas"));
  const checks = await getDocs(collection(db,"checklists"));
  const map={};
  checks.forEach(d=>{
    const c=d.data();
    if(!map[c.placa]||map[c.placa]<c.dataChecklist) map[c.placa]=c.dataChecklist;
  });

  placas.forEach(d=>{
    t++;
    const pca=d.data().placa;
    const st=status(map[pca]);
    if(st[0]==="Em dia")o++; else if(st[0]==="Pendente")p++; else v++;
    tabela.innerHTML+=`
      <tr>
        <td>${pca}</td>
        <td>${d.data().tipo}</td>
        <td>${map[pca]||"-"}</td>
        <td class="status ${st[1]}">${st[0]}</td>
        <td><button onclick="check('${pca}')">Checklist</button></td>
      </tr>`;
  });

  tTotal.innerText=t; tOk.innerText=o; tPend.innerText=p; tVenc.innerText=v;
}

/* CHECKLIST */
window.check = async (placa)=>{
  const data=new Date().toISOString().slice(0,10);
  await addDoc(collection(db,"checklists"),{
    placa,dataChecklist:data,
    userEmail:auth.currentUser.email,
    timestamp:new Date()
  });
  renderizar();
};

/* USU츼RIOS */
btnUsers.onclick=()=>usersPanel.classList.toggle("hidden");

async function carregarUsuarios(){
  usersTable.innerHTML="";
  const snap=await getDocs(collection(db,"users"));
  snap.forEach(d=>{
    const u=d.data();
    usersTable.innerHTML+=`
      <tr>
        <td>${u.email}</td>
        <td><span class="badge ${u.role}">${u.role}</span></td>
        <td><span class="badge ${u.active?"admin":"off"}">${u.active?"Ativo":"Bloqueado"}</span></td>
        <td>
          <button onclick="setRole('${d.id}','admin')">Admin</button>
          <button onclick="setRole('${d.id}','user')">User</button>
          <button onclick="toggle('${d.id}',${u.active})">${u.active?"Bloquear":"Ativar"}</button>
        </td>
      </tr>`;
  });
}

window.setRole=(id,r)=>{ updateDoc(doc(db,"users",id),{role:r}); carregarUsuarios(); }
window.toggle=(id,a)=>{ updateDoc(doc(db,"users",id),{active:!a}); carregarUsuarios(); }

/* EXCEL */
window.exportarExcel=()=>{
  const wb=XLSX.utils.table_to_book(document.querySelector("table"));
  XLSX.writeFile(wb,"checklist.xlsx");
};

/* TEMA */
theme.onclick=()=>document.body.classList.toggle("dark");
</script>

</body>
</html>
