<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist de Frota</title>
<link rel="icon" href="https://www.pralog.com.br/wp-content/uploads/2025/07/cropped-pralogverde-scaled-e1752780666907-32x32.png" sizes="32x32">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* RESET */
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,Helvetica,sans-serif;}

/* BODY E TEMAS */
body{background:#f4f6f8;color:#333;padding:20px;transition: all 0.3s;}
body.dark{background:#111827;color:#f4f4f4;}
body.dark .card{background:#1f2937;color:#f4f4f4;}
body.dark .filters, body.dark .table-container{background:#1f2937;color:#f4f4f4;}
body.dark input, body.dark select{background:#1f2937;color:#f4f4f4;border:1px solid #374151;}

/* HEADER */
.header{background:#1f2937;color:#fff;padding:20px;border-radius:10px;margin-bottom:20px;display:none;position:relative;transition: all 0.3s;}
.header h2{display:inline-block;}
#logoutBtn{position:absolute;top:20px;right:20px;background:#ef4444;padding:8px 16px;border:none;border-radius:8px;color:#fff;cursor:pointer;}
#logoutBtn:hover{background:#b91c1c;}

/* DASHBOARD */
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;display:none;transition: all 0.3s;}
.card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 8px rgba(0,0,0,.08);transition: all 0.3s;}
.card span{font-size:26px;font-weight:bold;}
.card.total{border-left:6px solid #3b82f6}
.card.ok{border-left:6px solid #22c55e}
.card.warning{border-left:6px solid #facc15}
.card.danger{border-left:6px solid #ef4444;animation: none;}
@keyframes piscar{0%,100%{opacity:1;}50%{opacity:0.4;}}
.status.danger{color:#dc2626;font-weight:bold;animation:piscar 1s infinite;}

/* FILTERS */
.filters{background:#fff;padding:15px;border-radius:10px;display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;display:none;transition: all 0.3s;}
.filters input,.filters select{padding:10px;border-radius:8px;border:1px solid #d1d5db;transition: all 0.3s;}
button{padding:8px 18px;border:none;border-radius:10px;background:#111827;color:#fff;cursor:pointer;transition: all 0.3s;}
button:hover{background:#1f2937}
button:disabled{opacity:.9}

/* TABELA */
.table-container{background:#fff;padding:15px;border-radius:10px;display:none;transition: all 0.3s;}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid #e5e7eb;}
thead th{border-bottom:2px solid #e5e7eb;}
.center{text-align:center;}
tbody tr:hover{background:#f9fafb;}

/* LOGIN */
#loginContainer{max-width:400px;margin:0 auto 20px auto;padding:20px;background:#fff;border-radius:10px;}
#loginContainer input{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #d1d5db;}
#loginContainer button{width:100%;margin-top:5px;}
#loginContainer h3{text-align:center;margin-bottom:10px;}
#loginMsg{color:red;margin-top:10px;text-align:center;}

/* RESPONSIVO */
@media (max-width:768px){
  .dashboard{grid-template-columns:1fr;}
  table, thead, tbody, th, td, tr{display:block;}
  th, td{padding:10px;}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginContainer">
  <h3>Login</h3>
  <input type="email" id="emailInput" placeholder="Email">
  <input type="password" id="senhaInput" placeholder="Senha">
  <button id="btnLogin">Entrar</button>
  <p style="text-align:center;margin:10px 0;">ou</p>
  <h3>Registrar</h3>
  <input type="email" id="emailReg" placeholder="Email">
  <input type="password" id="senhaReg" placeholder="Senha">
  <button id="btnRegister">Registrar</button>
  <p id="loginMsg"></p>
</div>

<!-- HEADER -->
<div class="header">
  <h2>Checklist Mensal da Frota</h2>
  <button id="logoutBtn">Sair</button>
  <button id="themeToggle" style="position:absolute;top:20px;left:20px;">üåô Tema</button>
</div>

<!-- DASHBOARD -->
<div class="dashboard">
  <div class="card total">Total<br><span id="total">0</span></div>
  <div class="card ok">Em dia<br><span id="ok">0</span></div>
  <div class="card warning">Pendentes<br><span id="pendente">0</span></div>
  <div class="card danger">Vencidos<br><span id="vencido">0</span></div>
</div>

<!-- FILTERS -->
<div class="filters">
  <input id="searchInput" placeholder="Pesquisar placa ou motorista">
  <input id="placaInput" placeholder="Placa">
  <select id="tipoInput">
    <option value="">Tipo</option>
    <option>Truck</option>
    <option>Carreta</option>
    <option>VUC</option>
    <option>Cavalo - Prafarma</option>
    <option>Cavalo - Pralog</option>
    <option>Cavalo - Pety</option>
  </select>
  <button id="btnCadastrar">Cadastrar</button>
  <input type="file" id="excelInput">
  <button onclick="exportarExcel()">Exportar Excel</button>
</div>

<!-- TABELA -->
<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Placa</th>
        <th class="center">Tipo</th>
        <th class="center">√öltimo Checklist</th>
        <th class="center">Status</th>
        <th class="center">Usu√°rio</th>
        <th class="center">A√ß√£o</th>
      </tr>
    </thead>
    <tbody id="tabela"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyB61mrR6417ECkuUCsbBqLU3KQ_hepXiQs",
  authDomain: "check-list-d32b1.firebaseapp.com",
  projectId: "check-list-d32b1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ELEMENTOS */
const loginContainer = document.getElementById("loginContainer");
const emailInput = document.getElementById("emailInput");
const senhaInput = document.getElementById("senhaInput");
const btnLogin = document.getElementById("btnLogin");
const emailReg = document.getElementById("emailReg");
const senhaReg = document.getElementById("senhaReg");
const btnRegister = document.getElementById("btnRegister");
const loginMsg = document.getElementById("loginMsg");
const logoutBtn = document.getElementById("logoutBtn");
const themeToggle = document.getElementById("themeToggle");

const placaInput = document.getElementById("placaInput");
const tipoInput = document.getElementById("tipoInput");
const btnCadastrar = document.getElementById("btnCadastrar");
const tabelaBody = document.getElementById("tabela");
const totalEl = document.getElementById("total");
const okEl = document.getElementById("ok");
const pendenteEl = document.getElementById("pendente");
const vencidoEl = document.getElementById("vencido");
const searchInput = document.getElementById("searchInput");

/* LOGIN */
btnLogin.onclick = async ()=>{
  const email=emailInput.value.trim();
  const senha=senhaInput.value.trim();
  if(!email||!senha){ loginMsg.style.color="red"; loginMsg.textContent="Preencha email e senha"; return; }
  try{ await signInWithEmailAndPassword(auth,email,senha); loginMsg.textContent=""; }catch(e){
    console.error(e);
    loginMsg.style.color="red";
    if(e.code==="auth/user-not-found") loginMsg.textContent="Usu√°rio n√£o encontrado";
    else if(e.code==="auth/wrong-password") loginMsg.textContent="Senha incorreta";
    else loginMsg.textContent="Erro ao entrar";
  }
}

/* REGISTRO */
btnRegister.onclick = async ()=>{
  const email=emailReg.value.trim();
  const senha=senhaReg.value.trim();
  if(!email||!senha){ loginMsg.style.color="red"; loginMsg.textContent="Preencha email e senha"; return; }
  try{
    const userCredential = await createUserWithEmailAndPassword(auth,email,senha);
    const user = userCredential.user;
    await setDoc(doc(db,"users",user.uid),{ role:"user", active:true });
    loginMsg.style.color="green"; loginMsg.textContent="Usu√°rio registrado! Fa√ßa login.";
  }catch(e){
    console.error(e);
    loginMsg.style.color="red";
    if(e.code==="auth/email-already-in-use") loginMsg.textContent="Email j√° cadastrado";
    else if(e.code==="auth/weak-password") loginMsg.textContent="Senha muito fraca";
    else loginMsg.textContent="Erro ao registrar usu√°rio";
  }
}

/* LOGOUT */
logoutBtn.onclick = async ()=>{ await signOut(auth); }

/* THEME */
themeToggle.onclick = ()=>{ document.body.classList.toggle("dark"); }

/* MONITORAR LOGIN */
onAuthStateChanged(auth, async (user)=>{
  if(user){
    const userDoc = await getDoc(doc(db,"users",user.uid));
    if(!userDoc.exists() || !userDoc.data().active){ alert("Usu√°rio desativado"); await signOut(auth); return; }

    loginContainer.style.display="none";
    document.querySelector(".header").style.display="block";
    document.querySelector(".dashboard").style.display="grid";
    document.querySelector(".filters").style.display="flex";
    document.querySelector(".table-container").style.display="block";

    const role=userDoc.data().role;
    if(role!=="admin") btnCadastrar.style.display="none";
    else btnCadastrar.style.display="inline-block";

    agendarRender();
  }else{
    loginContainer.style.display="block";
    document.querySelector(".header").style.display="none";
    document.querySelector(".dashboard").style.display="none";
    document.querySelector(".filters").style.display="none";
    document.querySelector(".table-container").style.display="none";
  }
});

/* RENDER SEM DUPLICAR */
let renderTimeout,isRendering=false,rerenderRequested=false;
async function renderizarSeguro(){
  if(isRendering){ rerenderRequested=true; return; }
  isRendering=true;
  try{ await renderizar(); }finally{
    isRendering=false;
    if(rerenderRequested){ rerenderRequested=false; await renderizarSeguro(); }
  }
}
function agendarRender(){ clearTimeout(renderTimeout); renderTimeout=setTimeout(renderizarSeguro,120); }

/* CADASTRO DE PLACAS */
btnCadastrar.onclick = async ()=>{
  const placa=placaInput.value.trim().toUpperCase();
  const tipo=tipoInput.value;
  if(!placa||!tipo){ alert("Preencha placa e tipo"); return; }
  const q=query(collection(db,"placas"),where("placa","==",placa));
  if(!(await getDocs(q)).empty){ alert("Placa j√° cadastrada"); return; }
  await addDoc(collection(db,"placas"),{placa,tipo});
  placaInput.value=""; tipoInput.value="";
  await renderizarSeguro();
  alert("‚úÖ Placa cadastrada com sucesso!");
}

/* CHECKLIST STATUS */
function calcularStatus(data){ 
  if(!data) return { texto:"Pendente",classe:"warning" };
  const hoje=new Date(); hoje.setHours(0,0,0,0);
  const check=new Date(data); check.setHours(0,0,0,0);
  const diff=Math.floor((hoje-check)/(1000*60*60*24));
  if(diff<30) return { texto:"Em dia",classe:"ok" };
  if(diff===30) return { texto:"Pendente",classe:"warning" };
  return { texto:"Vencido",classe:"danger" };
}

/* RENDER TABELA */
async function renderizar(){
  tabelaBody.innerHTML="";
  let total=0, ok=0, pend=0, venc=0;
  const [placasSnap, checksSnap]=await Promise.all([getDocs(collection(db,"placas")),getDocs(collection(db,"checklists"))]);
  const checks={};
  checksSnap.forEach(d=>{
    const c=d.data();
    if(!checks[c.placa]||checks[c.placa]<c.dataChecklist){ checks[c.placa]=c; }
  });

  const hojeISO=new Date().toISOString().slice(0,10);
  placasSnap.forEach(doc=>{
    const {placa,tipo}=doc.data(); total++;
    const c = checks[placa]||null;
    const data = c?c.dataChecklist:null;
    const userEmail = c?c.userEmail:"-";
    const st = calcularStatus(data);
    if(st.texto==="Em dia") ok++; else if(st.texto==="Pendente") pend++; else venc++;

    const feitoHoje = data===hojeISO;
    tabelaBody.innerHTML+=`
      <tr>
        <td>${placa}</td>
        <td class="center">${tipo}</td>
        <td class="center">${data?data.split("-").reverse().join("/"):"-"}</td>
        <td class="center status ${st.classe}">${st.texto}</td>
        <td class="center">${userEmail}</td>
        <td class="center">
          <button ${feitoHoje?'disabled style="background:#16a34a;cursor:default;"':''} onclick="salvarChecklist('${placa}',this)">
            ${feitoHoje?"‚úî Feito":"Checklist"}
          </button>
        </td>
      </tr>`;
  });

  totalEl.innerText=total; okEl.innerText=ok; pendenteEl.innerText=pend; vencidoEl.innerText=venc;

  if(venc>0) alert(`‚ö† Existem ${venc} checklists vencidos!`);
}

/* SALVAR CHECKLIST */
window.salvarChecklist=async (placa,botao)=>{
  try{
    botao.disabled=true; botao.textContent="Salvando..."; botao.style.background="#f59e0b"; botao.style.cursor="default";
    const hoje=new Date(); hoje.setHours(0,0,0,0);
    const data=hoje.toISOString().slice(0,10);
    const q=query(collection(db,"checklists"),where("placa","==",placa),where("dataChecklist","==",data));
    if(!(await getDocs(q)).empty){ alert("Checklist j√° feito hoje"); await renderizarSeguro(); return; }
    await addDoc(collection(db,"checklists"),{ placa,dataChecklist:data, userId:auth.currentUser.uid, userEmail:auth.currentUser.email, timestamp:new Date() });
    await renderizarSeguro();
    botao.textContent="‚úî Feito"; botao.style.background="#16a34a"; botao.disabled=true;
  }catch(e){ console.error(e); alert("Erro ao salvar checklist!"); if(botao){ botao.disabled=false; botao.textContent="Checklist"; botao.style.background="#111827"; botao.style.cursor="pointer"; } }
}

/* PESQUISA R√ÅPIDA */
searchInput.addEventListener("input", e=>{
  const term=e.target.value.toLowerCase();
  document.querySelectorAll("#tabela tr").forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(term)?"":"none";
  });
});

/* ATUALIZA√á√ÉO AUTOM√ÅTICA */
onSnapshot(collection(db,"placas"),agendarRender);
onSnapshot(collection(db,"checklists"),agendarRender);
agendarRender();

/* EXPORTAR EXCEL */
window.exportarExcel=function(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.table_to_sheet(document.querySelector("table"));
  XLSX.utils.book_append_sheet(wb,ws,"Checklist");
  XLSX.writeFile(wb,"Checklist.xlsx");
};
</script>
</body>
</html>
