<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist de Frota</title>

<!-- XLSX para importar / exportar Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Arial, Helvetica, sans-serif;
}

body {
  background-color: #f4f6f8;
  color: #333;
  padding: 20px;
}

.header {
  background: #1f2937;
  color: #fff;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.card {
  background: #ffffff;
  border-radius: 12px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  box-shadow: 0 4px 8px rgba(0,0,0,.08);
}

.card span {
  font-size: 26px;
  font-weight: bold;
}

.card.total { border-left: 6px solid #3b82f6; }
.card.ok { border-left: 6px solid #22c55e; }
.card.warning { border-left: 6px solid #facc15; }
.card.danger { border-left: 6px solid #ef4444; }

.filters {
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.filters input, .filters select {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
}

button {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  background: #1f2937;
  color: #fff;
  cursor: pointer;
}

.table-container {
  background: #fff;
  padding: 15px;
  border-radius: 10px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 12px;
  border-bottom: 1px solid #e5e7eb;
}

.status.ok { color: #22c55e; font-weight: bold; }
.status.warning { color: #facc15; font-weight: bold; }
.status.danger { color: #ef4444; font-weight: bold; }
</style>
</head>

<body>

<div class="header">
  <h2>Checklist Mensal da Frota</h2>
</div>

<div class="dashboard">
  <div class="card total">Total<br><span id="total">0</span></div>
  <div class="card ok">Em dia<br><span id="emdia">0</span></div>
  <div class="card warning">Pendentes<br><span id="pendente">0</span></div>
  <div class="card danger">Vencidos<br><span id="vencido">0</span></div>
</div>

<div class="filters">
  <input id="placaInput" placeholder="Placa (ABC1D23)">
  <select id="tipoInput">
    <option value="">Tipo</option>
    <option>Truck</option>
    <option>Carreta</option>
    <option>VUC</option>
  </select>
  <button onclick="cadastrarPlaca()">Cadastrar placa</button>

  <input type="file" id="excelInput">
  <button onclick="exportarExcel()">Exportar Excel</button>
</div>

<div class="table-container">
<table>
<thead>
<tr>
  <th>Placa</th>
  <th>Tipo</th>
  <th>Último Checklist</th>
  <th>Status</th>
  <th>Ação</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  onSnapshot, query, where
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB61mrR6417ECkuUCsbBqLU3KQ_hepXiQs",
  authDomain: "check-list-d32b1.firebaseapp.com",
  projectId: "check-list-d32b1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* STATUS */
function statusChecklist(data){
  const hoje=new Date();hoje.setHours(0,0,0,0);
  const d=new Date(data);d.setHours(0,0,0,0);
  const diff=(hoje-d)/86400000;
  if(diff>30) return ['Vencido','danger'];
  if(diff===30) return ['Pendente','warning'];
  return ['Em dia','ok'];
}

/* CADASTRAR PLACA */
window.cadastrarPlaca = async ()=>{
  const placa = placaInput.value.trim().toUpperCase();
  const tipo = tipoInput.value;
  if(!placa || !tipo) return alert('Preencha placa e tipo');

  const q=query(collection(db,'placas'),where('placa','==',placa));
  if(!(await getDocs(q)).empty) return alert('Placa já cadastrada');

  await addDoc(collection(db,'placas'),{placa,tipo});
  placaInput.value=''; tipoInput.value='';
};

/* CHECKLIST 1 CLIQUE (BLOQUEIO DUPLICADO) */
window.salvarChecklist = async (placa)=>{
  const hoje=new Date();hoje.setHours(0,0,0,0);
  const data=hoje.toISOString().slice(0,10);
  const q=query(collection(db,'checklists'),
    where('placa','==',placa),
    where('dataChecklist','==',data)
  );
  if(!(await getDocs(q)).empty) return alert('Checklist já feito hoje');

  await addDoc(collection(db,'checklists'),{placa,dataChecklist:data});
};

/* IMPORTAR EXCEL */
excelInput.onchange = async e=>{
  const wb=XLSX.read(await e.target.files[0].arrayBuffer());
  XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]])
    .forEach(r=>addDoc(collection(db,'placas'),r));
};

/* EXPORTAR EXCEL */
window.exportarExcel = async ()=>{
  const dados=[];
  (await getDocs(collection(db,'placas'))).forEach(d=>dados.push(d.data()));
  const ws=XLSX.utils.json_to_sheet(dados);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Frota');
  XLSX.writeFile(wb,'frota.xlsx');
};

/* TABELA */
onSnapshot(collection(db,'placas'), snap=>{
  tabela.innerHTML='';
  total.innerText=snap.size;
  let e=0,p=0,v=0;

  snap.forEach(pDoc=>{
    onSnapshot(query(collection(db,'checklists'),where('placa','==',pDoc.data().placa)), s=>{
      let u=null;
      s.forEach(c=>{const d=new Date(c.data().dataChecklist);if(!u||d>u)u=d});
      const [t,c]=u?statusChecklist(u):['Pendente','warning'];
      if(t==='Em dia')e++; if(t==='Pendente')p++; if(t==='Vencido')v++;
      tabela.innerHTML+=`
      <tr>
        <td>${pDoc.data().placa}</td>
        <td>${pDoc.data().tipo}</td>
        <td>${u?u.toLocaleDateString():'-'}</td>
        <td class="status ${c}">${t}</td>
        <td><button onclick="salvarChecklist('${pDoc.data().placa}')">Checklist</button></td>
      </tr>`;
    });
  });

  emdia.innerText=e; pendente.innerText=p; vencido.innerText=v;
});
</script>

</body>
</html>
