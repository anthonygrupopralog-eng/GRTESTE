<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist de Frota</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{background:#f4f6f8;color:#333;padding:20px}
.header{background:#1f2937;color:#fff;padding:20px;border-radius:10px;margin-bottom:20px}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
.card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 8px rgba(0,0,0,.08)}
.card span{font-size:26px;font-weight:bold}
.card.total{border-left:6px solid #3b82f6}
.card.ok{border-left:6px solid #22c55e}
.card.warning{border-left:6px solid #facc15}
.card.danger{border-left:6px solid #ef4444}

.filters{background:#fff;padding:15px;border-radius:10px;display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px}
.filters input,.filters select{padding:10px;border-radius:8px;border:1px solid #d1d5db}

button{padding:8px 18px;border:none;border-radius:10px;background:#111827;color:#fff;cursor:pointer}
button:hover{background:#1f2937}

.table-container{background:#fff;padding:15px;border-radius:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid #e5e7eb}
thead th{border-bottom:2px solid #e5e7eb}
.center{text-align:center}
.status.ok{color:#16a34a;font-weight:bold}
.status.warning{color:#ca8a04;font-weight:bold}
.status.danger{color:#dc2626;font-weight:bold}
tbody tr:hover{background:#f9fafb}
</style>
</head>

<body>

<div class="header">
  <h2>Checklist Mensal da Frota</h2>
</div>

<div class="dashboard">
  <div class="card total">Total<br><span id="total">0</span></div>
  <div class="card ok">Em dia<br><span id="emdia">0</span></div>
  <div class="card warning">Pendentes<br><span id="pendente">0</span></div>
  <div class="card danger">Vencidos<br><span id="vencido">0</span></div>
</div>

<div class="filters">
  <input id="placaInput" placeholder="Placa">
  <select id="tipoInput">
    <option value="">Tipo</option>
    <option>Truck</option>
    <option>Carreta</option>
    <option>VUC</option>
  </select>
  <button onclick="cadastrarPlaca()">Cadastrar</button>

  <input type="file" id="excelInput">
  <button onclick="exportarExcel()">Exportar Excel</button>
</div>

<div class="table-container">
<table>
<thead>
<tr>
  <th>Placa</th>
  <th class="center">Tipo</th>
  <th class="center">Último Checklist</th>
  <th class="center">Status</th>
  <th class="center">Ação</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  onSnapshot, query, where
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB61mrR6417ECkuUCsbBqLU3KQ_hepXiQs",
  authDomain: "check-list-d32b1.firebaseapp.com",
  projectId: "check-list-d32b1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* CADASTRAR PLACA */
window.cadastrarPlaca = async ()=>{
  const placa=placaInput.value.trim().toUpperCase();
  const tipo=tipoInput.value;
  if(!placa||!tipo) return alert('Preencha placa e tipo');

  const q=query(collection(db,'placas'),where('placa','==',placa));
  if(!(await getDocs(q)).empty) return alert('Placa já cadastrada');

  await addDoc(collection(db,'placas'),{placa,tipo});
  placaInput.value=''; tipoInput.value='';
};

/* CHECKLIST */
window.salvarChecklist = async placa=>{
  const hoje=new Date();hoje.setHours(0,0,0,0);
  const data=hoje.toISOString().slice(0,10);

  const q=query(collection(db,'checklists'),
    where('placa','==',placa),
    where('dataChecklist','==',data)
  );

  if(!(await getDocs(q)).empty) return alert('Checklist já feito hoje');

  await addDoc(collection(db,'checklists'),{placa,dataChecklist:data});
  await renderizarTabela();
};

/* IMPORTAR EXCEL */
excelInput.onchange = async e=>{
  const wb=XLSX.read(await e.target.files[0].arrayBuffer());
  const dados=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
  for(const d of dados) await addDoc(collection(db,'placas'),d);
};

/* EXPORTAR EXCEL */
window.exportarExcel = async ()=>{
  const arr=[];
  (await getDocs(collection(db,'placas'))).forEach(d=>arr.push(d.data()));
  const ws=XLSX.utils.json_to_sheet(arr);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Frota');
  XLSX.writeFile(wb,'frota.xlsx');
};

/* RENDERIZAÇÃO CENTRAL */
async function renderizarTabela(){
  tabela.innerHTML='';
  const placasSnap=await getDocs(collection(db,'placas'));
  const checkSnap=await getDocs(collection(db,'checklists'));

  const mapa={};
  checkSnap.forEach(d=>{
    const {placa,dataChecklist}=d.data();
    const dt=new Date(dataChecklist);
    if(!mapa[placa]||dt>mapa[placa]) mapa[placa]=dt;
  });

  let e=0,p=0,v=0;

  placasSnap.forEach(doc=>{
    const {placa,tipo}=doc.data();
    const ultima=mapa[placa];
    let status='Pendente',cls='warning',dataTxt='-';

    if(ultima){
      const hoje=new Date();hoje.setHours(0,0,0,0);
      ultima.setHours(0,0,0,0);
      const dias=(hoje-ultima)/86400000;
      dataTxt=ultima.toLocaleDateString();

      if(dias<30){status='Em dia';cls='ok';e++}
      else if(dias===30){status='Pendente';cls='warning';p++}
      else{status='Vencido';cls='danger';v++}
    } else p++;

    tabela.innerHTML+=`
    <tr>
      <td>${placa}</td>
      <td class="center">${tipo}</td>
      <td class="center">${dataTxt}</td>
      <td class="center status ${cls}">${status}</td>
      <td class="center">
        <button onclick="salvarChecklist('${placa}')">Checklist</button>
      </td>
    </tr>`;
  });

  total.innerText=placasSnap.size;
  emdia.innerText=e;
  pendente.innerText=p;
  vencido.innerText=v;
}

onSnapshot(collection(db,'placas'),renderizarTabela);
onSnapshot(collection(db,'checklists'),renderizarTabela);
</script>

</body>
</html>
